<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans 
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context 
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security.xsd
        http://www.springframework.org/schema/mvc 
        http://www.springframework.org/schema/mvc/spring-mvc.xsd">

  <description>
  </description>

  <!--
  ############################################################################### 
  geOrchestra specific configuration
  ############################################################################### 
  -->
  
  <!-- geOrchestra Commons -->
  <bean id="georchestraConfiguration" class="org.georchestra.commons.configuration.GeorchestraConfiguration">
    <constructor-arg value="geowebcache" />
  </bean>

  <context:property-placeholder location="file:${georchestra.datadir}/default.properties"
                                ignore-resource-not-found="true"
                                ignore-unresolvable="true"
                                order="1" />
  <context:property-placeholder location="file:${georchestra.datadir}/geowebcache/geowebcache.properties"
                                ignore-resource-not-found="true"
                                ignore-unresolvable="true"
                                order="0" />
  
  
  <!-- Override geowebCacheDispatcher defined in core-context.xml -->
  <bean id="geowebcacheDispatcher" class="org.georchestra.geowebcache.GeorchestraGeoWebCacheDispatcher" destroy-method="destroy">
    <constructor-arg ref="gwcTLDispatcher"/>
    <constructor-arg ref="gwcGridSetBroker"/>
    <constructor-arg ref="gwcStorageBroker"/>
    <constructor-arg ref="gwcBlobStoreAggregator"/>
    <constructor-arg ref="gwcXmlConfig"/>
    <constructor-arg ref="gwcRuntimeStats"/>
    <property name="defaultStorageFinder" ref="gwcDefaultStorageFinder"/>
    <property name="securityDispatcher" ref="gwcSecurityDispatcher"/>
    <property name="instanceName" value="${instanceName}"/>
    <property name="headerUrl" value="${headerUrl}"/>
    <property name="headerHeight" value="${headerHeight}"/>
  </bean>
  
  <!-- Override gwcURLMangler defined in core-context.xml -->
  <bean id="gwcURLMangler" class="org.georchestra.geowebcache.GeorchestraURLMangler">
    <constructor-arg value="${publicUrl:${scheme}://${domainName}}" />
    <constructor-arg value="${contextPath:/geowebcache}" />
  </bean>

  <!-- Override security configuration to use geOrchestra's http headers-->
  <bean id="preAuthFilter" class="org.georchestra.geowebcache.security.PreAuthFilter"/>
  <bean id="daoAuthenticationProvider" class="org.georchestra.geowebcache.security.PreAuthProvider"/>
  
    <security:authentication-manager>
	    <security:authentication-provider ref="daoAuthenticationProvider" />
    </security:authentication-manager>
    
    <security:http>
        <security:intercept-url method="GET" pattern="/rest/web/**" access="permitAll"/>
        <security:intercept-url method="GET" pattern="/rest/wmts/WMTSCapabilities.xml" access="permitAll"/>
        <security:intercept-url pattern="/rest/**" access="hasRole('ROLE_ADMINISTRATOR')"/>
        
        <security:http-basic entry-point-ref="authenticationEntryPoint"/>
        <security:csrf disabled="true"/> <!-- TODO Update forms so we can enable this -->
    </security:http>
    
    <bean id="authenticationEntryPoint"
        class="org.springframework.security.web.authentication.www.BasicAuthenticationEntryPoint">
        <property name="realmName" value="GeoWebCache Secured"/>
    </bean>
    
</beans>
